<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Stock Trading Portfolio</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <!-- <link href="assets/lib/bootstrap/css/bootstrap.css" rel="stylesheet"> -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/common/portfolio.css" rel="stylesheet">
  </head>
  <body>

    <header class="container">
      <div id="heading" class="masthead">
        <div class="pull-right">
        	<button data-bind="click: logout" class="btn"><i class="icon-off"></i></button>
        </div>
        <h2>Chat Roomm!</h2>
        <div class="pull-right" id="notifications"> </div>
        <div id="chatTest"> </div>
        <div class="alert alert-info" style="display:none" id="joinedChat"></div>
      </div>
   </header>
   
   <section class="main container">
     <div class="row">
    	<div class="col-md-12">
	   		<p class="lead">Type in the box below to start a chat!</p>
	   		
	   	</div> 
     
     </div>
   	
   	<div class="row">
   		<div class="col-md-12">
   		
   			<form role="form" id="chatForm">
			  <div class="form-group">
			    <label for="to">Send To</label>
			    <select class="form-control" id="to" name="to">
			    	<option value="">Select Recipient</option>
			    	<option value="bill">Bill</option>
			    	<option value="steve">Steve</option>
			    </select>
			  </div>
			  <div class="form-group">
			    <label for="message">Message</label>
			    <textarea class="form-control" id="message" name="message" placeholder="Message..." rows="3"></textarea>
			  </div>
			  <input type="submit" id="send" name="send" class="btn btn-primary" value="Send.." />
   			</form>
   		
   		</div>
   	
   	</div>
   	
   	<div class="row">
   		<div class="col-md-12" id="chats">
   			
   		
   		</div>
   		
   	
   	</div>
   	
 
   
   </section>
   
  
    <!-- 3rd party -->
    <script src="assets/lib/jquery/jquery.js"></script>
    <script src="assets/lib/bootstrap/js/bootstrap.js"></script>
    <script src="assets/lib/knockout/knockout.js"></script>
    <script src="assets/lib/sockjs/sockjs.js"></script>
    <script src="assets/lib/stomp/dist/stomp.js"></script>

    <!-- application -->
    <script src="portfolio.js"></script>
    <script type="text/javascript">
    var client = null;
    var username = null;
      (function() {
        var socket = new SockJS('/chatter/portfolio');
        client = Stomp.over(socket);

       /*  var appModel = new ApplicationModel(client);
        ko.applyBindings(appModel);
         */
        client.connect('steve', 'pass', function(frame) {

	        console.log('Connected ' + frame);
	        userName = frame.headers['user-name'];
	        var queueSuffix = frame.headers['queue-suffix'];
	        
	        console.log(userName);
	        console.log(queueSuffix);
	        client.subscribe("/queue/time-updates", function(message) {
	      		$('#notifications').html('<span>' + JSON.parse(message.body) + '</span>'); 
	        });
	        
	        
	        client.subscribe("/queue/chats" + queueSuffix, function(message) {
	        	console.log("Received chat! ::");
	        	message = JSON.parse(message.body);
	        	console.log(message);
	      		$('#chats').prepend(
	      				'<div class="incoming chat"><span class="from">' 
	      					+ message.from + 
	      					'</span><span class="message">' + message.message + '</span</div>').fadeIn(); 
	        });
	        
	        client.subscribe('/app/join');
	        
	        // be notified of other joins
	        client.subscribe("/topic/join", function(message) {
	        	console.log(message);
	        	message = JSON.parse(message.body);
	        	$('#to').append('<option value="' + message + '">' + message + '</option>');
	        	$('#joinedChat').text(message + ' has joined the chat!').fadeIn(100).delay(2000).fadeOut(200);
	      		console.log('new user joined');
	      		console.log(message);
	        });
	        
	        client.subscribe("/app/test", function(message) {
	    	  console.log("SUBSCRIBED TO TEST: " + JSON.parse(message.body));
	        });
	        
	        client.send("/app/trade", {}, "TEST");
	      //  client.send("/app/chat", {}, JSON.stringify({message: "SDFSDF", to: "BILL"}));
        });
        
        $('#chatForm').submit(function() {
        	console.log("Sending..");
        	//console.log($(this).serialize());
        	data = { 
        			to: $('#to').val(), 
        			message: $('#message').val()
        	};
        	console.log(JSON.stringify(data));
        	console.log(JSON.stringify({message: "This is an auto test", from: "BILL"}));
        	client.send("/app/chat", {}, JSON.stringify(data));
        	//client.send("/app/chat", {}, JSON.stringify({message: "This is an auto test", from: "BILL"}));
        	$('#chats').prepend(
      				'<div class="outgoing chat"><span class="from">' + userName 
      				+ '</span><span class="message">' + $('#message').val() + '</span</div>');
        	$('#message').val('');
        	$('#message').focus();
        	
        	return false;
        });

      //  appModel.connect();
      //  appModel.pushNotification("Trade results take a 2-3 second simulated delay. Notifications will appear.");
      })();
    </script>

  </body>
</html>
